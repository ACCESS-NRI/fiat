MODULE MPL_ABORT_MOD

#ifdef NAG
use f90_unix_proc, only: abort
#endif
USE MPL_DATA_MODULE
USE MPL_MPIF
USE YOMOML
USE YOMABRT

USE PARKIND1  ,ONLY : JPIM     ,JPRB

PUBLIC MPL_ABORT

CONTAINS 

SUBROUTINE MPL_ABORT(CDMESSAGE)

IMPLICIT NONE

CHARACTER*(*),INTENT(IN),OPTIONAL :: CDMESSAGE
INTEGER(KIND=JPIM) :: IRETURN_CODE,IERROR,ITID
ITID=OML_MY_THREAD()

CLOSE(MPL_UNIT)
#ifdef VPP
CALL ERRTRA
CALL SLEEP(30)
CALL VPP_ABORT()

#elif RS6K
CALL FLUSH(0)
CALL SYSTEM("sleep 2")
!------Traceback from only one thread
CALL OML_SET_LOCK(MYLOCK=MAB_LOCK)
IF(MAB_CNT == 0) THEN
  WRITE(MPL_ERRUNIT,'(A,I6,A,I6)') 'MPL_ABORT: CALLED FROM PROCESSOR ',MPL_RANK,' THRD',ITID
  IF(PRESENT(CDMESSAGE)) THEN
    WRITE(MPL_ERRUNIT,*) 'MPL_ABORT: THRD',ITID,"  ",CDMESSAGE
  ENDIF
  WRITE(0,*)'MPL_ABORT: Calling XL_TRBK, THRD = ',ITID
  MAB_CNT=1
  CALL XL__TRBK()
  WRITE(0,*)'MPL_ABORT: Done XL_TRBK, THRD = ',ITID
  CALL FLUSH(0)
  CALL SYSTEM("sleep 1")
ENDIF
CALL OML_UNSET_LOCK(MYLOCK=MAB_LOCK)
! ------All threads wait till traceback done
CALL FLUSH(0)
CALL SYSTEM("sleep 1")
IRETURN_CODE=1
CALL MPI_ABORT(MPL_COMM_OML(ITID),IRETURN_CODE,IERROR)
#else
IRETURN_CODE=1
CALL MPI_ABORT(MPL_COMM_OML(ITID),IRETURN_CODE,IERROR)
CALL ABORT
STOP 'MPL_ABORT'
#endif
END SUBROUTINE MPL_ABORT

END MODULE MPL_ABORT_MOD

